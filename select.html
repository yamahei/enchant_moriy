<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <!-- <script type="text/javascript" src="plugins/plugin-loader.js"></script>
    <link rel="stylesheet" href="plugins/plugin-loader.css" /> -->
    <link rel="shortcut icon" href="promote/iconimage_moriy_512x512.png"></link>
    <link rel="stylesheet" href="./bitfont.css" />

    <!-- PWA -->
    <!-- <link rel="manifest" href="manifest.webmanifest"></link>
    <script type="text/javascript" src="./registpwa.js"></script> -->

    <script type="text/javascript">

      const episodes = [
        {no: 0, difficulty: 0, title: 'Prolog', image: './siteimg/epimg_prolog.png'},
        {no: 1, difficulty: 0, title: 'Brightness', image: './siteimg/epimg_brightness.png'},
        {no: 7, difficulty: 1, title: 'Forecourt', image: './siteimg/epimg_forecourt.png'},
        {no: 8, difficulty: 2, title: 'Mausoleum', image: './siteimg/epimg_mausoleum.png'},
        {no: 4, difficulty: 2, title: 'Passkey', image: './siteimg/epimg_passkey.png'},
        {no: 2, difficulty: 1, title: 'Banners', image: './siteimg/epimg_ribbons.png'},
        {no: 6, difficulty: 1, title: 'Loophole', image: './siteimg/epimg_loophole.png'},
        {no: 5, difficulty: 3, title: 'Dungeon', image: './siteimg/epimg_dungeon.png'},
        {no: 3, difficulty: 3, title: 'Maze', image: './siteimg/epimg_maze.png'},
        {no: 9, difficulty: 3, title: 'Core', image: './siteimg/epimg_core.png'},
        {no: 10, difficulty: 2, title: 'Lyra', image: './siteimg/epimg_lyra.png'},
        {no: 11, difficulty: 1, title: 'Epilogue', image: './siteimg/epimg_epilogue.png'},
      ];

      function loadData(){
        const emptydata = {
          unlock: -1,// cleard episode index
        };
        const rawjson = localStorage.getItem("Moriy");
        const json = rawjson ? JSON.parse(rawjson) : emptydata;
        return json;
      }

      function onClickEpisode(episode, index){
        console.debug({episode, index});
        const episodeno = ("00" + episode.no).slice(-2);
        const filename = `stage${episodeno}.html`;

        const params = new URLSearchParams();
        params.append("no", episode.no);
        params.append("index", index);
        params.append("filename", filename);

        const nextpath = "story.html?" + params.toString();
        window.location = nextpath;
      }

      function xpath(path){
        return document.evaluate(path, document, null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null );
      }

      function scrollToLatestEpisode(unlock){
        const $elements = [...document.getElementById("episodes").childNodes];
        const $episodes = $elements.filter(($el)=>{
          if($el.nodeName=="#text"){ return false; }
          return (/\bepisode\b/).test(`${$el.getAttribute("class")}`);
        });
        const $episode = $episodes[unlock] || $episodes[0];
        if($episode){
          $episode.scrollIntoView({behavior: 'smooth', block: 'center'});
        }
      }

      window.onload = function(){
        const data = loadData();

        const $episodes = document.getElementById("episodes");
        const $uppermargin = document.createElement("div");
        $uppermargin.setAttribute("class", "margin");
        $episodes.appendChild($uppermargin);

        episodes.forEach((episode, index)=>{
          const unlock = !!(index <= data.unlock);
          const isnext = !!(index <= data.unlock + 1)
          const boxclass = isnext ? "episode unlock" : "episode";
          const $box = document.createElement("div");
          $box.setAttribute("class", boxclass);
          if(isnext){
            $box.addEventListener("click", ()=>{
              onClickEpisode(episode, index)
            });
          }

          const $img = document.createElement("img");
          $img.setAttribute("src", episode.image);
          $img.setAttribute("class", "epimg");
          $box.appendChild($img);

          const $label = document.createElement("div");
          $label.setAttribute("class", "label");

          const $title = document.createElement("p");
          $title.textContent = episode.title;
          $title.setAttribute("class", "title");
          $label.appendChild($title);

          const $difficulty = document.createElement("p");
          $difficulty.setAttribute("class", "difficulty");

          for(var i=1; i<=3; i++){
            const srcon = "./siteimg/lamp_on.png";
            const srcoff = "./siteimg/lamp_off.png";
            const src = (episode.difficulty >= i) ? srcon : srcoff;
            const $lampimg = document.createElement("img");
            $lampimg.setAttribute("src", src);
            $difficulty.appendChild($lampimg);
          }
          $label.appendChild($difficulty);
          $box.appendChild($label);
          $episodes.appendChild($box);

        });
        const $undermargin = document.createElement("div");
        $undermargin.setAttribute("class", "margin");
        $episodes.appendChild($undermargin);

        scrollToLatestEpisode(data.unlock);
      }
    </script>
    <title>Moriy - the deep fact</title>
    <style type="text/css">
        /* define in bitfont.css
        :root {
            --text-length: 32;
            --font-size: calc(100vw / var(--text-length))
        } */

        body {
          margin: 0 0; padding: 0 0;
          /* width: 400px; */
          color: silver;
          background-color: #000;
          overflow: hidden;
        }
        div.top{
          margin: 0;
          padding: 0;
          min-height: 100vh;
          max-height: 100vh;
          display: flex;
          justify-content: center;
        }
        div.side{
          margin: 0;
          padding: 0;
          width: 50vw;
        }
        div.side.left{
          align-content: center;
        }
        div.side.left img{
          display: block;
          margin: auto;
          width: calc(var(--font-size) * 10);
        }
        div.side.right{
          overflow: auto;
        }
        #episodes .margin{
          height:50vh;
        }
        .episode{
          display: flex;
          align-items: flex-start;
          color:gray;
          margin-top: calc(var(--font-size));
          margin-bottom: calc(var(--font-size));
        }
        .episode.unlock{
          cursor: pointer;
          color:silver;
        }
        img.epimg {
          border: 1px solid gray;
          width: calc(var(--font-size) * 2);
        }
        div.label{
          margin-top: 0.2rem;
          margin-left: calc(var(--font-size) / 2);
        }
        p.title {
          margin: 0;
          padding: 0;
          font-size: calc(var(--font-size) * 0.75);
        }
        p.difficulty{
          margin: 0;
          padding: 0;
        }
        p.difficulty img{
          width: calc(var(--font-size) * 0.5);
        }


    </style>
  </head>

  <body>
    <div class="top">
      <div class="side left">
        <img src="./assets/image/GameMsg_SelectEpisode.png"  />
      </div>
      <div class="side right">

        <div id="episodes" class="bitfont">
        </div>

      </div>

    </div>


  </body>
</html>

