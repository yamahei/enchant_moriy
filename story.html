<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <!-- <script type="text/javascript" src="plugins/plugin-loader.js"></script>
    <link rel="stylesheet" href="plugins/plugin-loader.css" /> -->
    <link rel="shortcut icon" href="promote/iconimage_moriy_512x512.png"></link>
    <link rel="stylesheet" href="./bitfont.css" />

    <!-- PWA -->
    <!-- <link rel="manifest" href="manifest.webmanifest"></link>
    <script type="text/javascript" src="./registpwa.js"></script> -->

    <script type="text/javascript">
      const episodes = [
        {no: 0, title: 'Prolog'},
        {no: 1, title: 'Brightness'},
        {no: 7, title: 'Forecourt'},
        {no: 8, title: 'Mausoleum'},
        {no: 4, title: 'Passkey'},
        {no: 2, title: 'Banners'},
        {no: 6, title: 'Loophole'},
        {no: 5, title: 'Dungeon'},
        {no: 3, title: 'Maze'},
        {no: 9, title: 'Core'},
        {no: 10, title: 'Lyra'},
        {no: 11, title: 'Epilogue'},
      ];

      function gotoStage(episode){
        const no = episode.no;
        const filename = `stage${("00" + no).slice(-2)}.html`;
        window.location = filename;
        //TODO: save last episode to localStorage
      }

      window.onload = function(){
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);
        const no = Number(params.get('no'));
        const index = Number(params.get('index'));
        const filename = params.get('filename');
        const episode = episodes[index];
        if(episode.no !== no){
          console.error({no, index, filename, episode});
          throw new Error("Invalid episode data");
        }
        const id = `stage${("00" + no).slice(-2)}:${episode.title}`;
        const $story = document.getElementById(id);
        if(!$story){
          console.error({id, episode});
          throw new Error("Story not found");
        }

        const $episode = $story.querySelector("p.title span.index");
        $episode.textContent = `Episode ${("00" + index).slice(-2)}`;
        const $title = $story.querySelector("p.title span.name");
        $title.textContent = episode.title;

        const rect = $story.getBoundingClientRect();
        const top = rect.top;
        const bottom = rect.bottom;
        const height = rect.height;
        const speed = 50 / height;

        let touching = false;
        document.addEventListener("mousedown", (e)=>{touching = true;});
        document.addEventListener("touchstart", (e)=>{touching = true;});
        document.addEventListener("mouseup", (e)=>{touching = false;});
        document.addEventListener("touchend", (e)=>{touching = false;});
        document.addEventListener("dblclick", (e)=>{ gotoStage(episode); });

        const boost = 10;
        const interval = 1000 / 60; // 60 FPS
        let currenttop = 100;
        const scroll = function(){
          currenttop -= speed * (touching ? boost : 1);
          $story.style.top = `${currenttop}vh`;
          if($story.getBoundingClientRect().bottom < 0){
            gotoStage(episode);
          }else{
            setTimeout(scroll, interval);
          }
        };
        scroll();
      }

    </script>
    <title>Moriy - the deep fact</title>
    <style type="text/css">
        /* define in bitfont.css
        :root {
            --text-length: 32;
            --font-size: calc(100vw / var(--text-length))
        } */

        body {
          margin: 0 0; padding: 0 0;
          min-width: 100vw;
          min-height: 100vh;
          /* width: 400px; */
          color: silver;
          background-color: #000;
          overflow: hidden;
        }

        section.story {
          position: absolute;
          top: 100vh; left: 0;
          /* min-height: 100vh; */
          width: calc(100vw - var(--font-size) * 6);
          padding-left: calc(var(--font-size) * 3);
          padding-right: calc(var(--font-size) * 3);
          font-size: calc(var(--font-size) * 1);
          line-height: 2em;
        }
        section.story p.title {
          text-align: center;
          margin-bottom: calc(var(--font-size) * 6);
        }

    </style>
  </head>

  <body>
    <section id="stage00:Prolog" class="story bitfont">
      <p class="title">
        <span class="index"></span><br/><span class="name"></span>
      </p>
      <p>
        どんより と ぶあつい くもり空 を 見上げながら ヨシュナ は 考えていた。
        なぜ 自分 の ような みぶん の ひくい もの が しんえいたい の たいちょう に えらばれたのか。
      </p>
      <p>
        みぶん の たかい どうりょう たち の せんぼう と ねたみ そねみ の まなざし は ヨシュナ には いたい ほど に かんじられた。
        国王 に 自分 を すいせん した 大そうじょう さま は いったい どういう つもり なのか。
      </p>
      <p><br/></p>
      <p>
        とき を 同じくして 王国 には いへん が おこりはじめていた。
        しぜんさいがい の ぞうか や てんこう の ふじゅん による ふさく が 目に 見えて ふえた。
      </p>
      <p>
        ひとびと は 光 の めがみ ライラ の かご が うすれ ヤミ の 女王 アリル が ふっかつ するのではないか と うわさする よう に なった。
      </p>
      <p><br/></p>
      <p>
        しんまい たいちょう の ヨシュナ に 手だて など あるはず も なく 不安 な きもち を おしころす ように くんれん に はげむ の だった。
      </p>
    </section>
    <section id="stage01:Brightness" class="story bitfont">
      <p class="title">
        <span class="index"></span><br/><span class="name"></span>
      </p>

      <p>
        ここ は 光 の めがみ ライラ の かご に 守られた 平和 な 王国 モーリィ。
        おんだん な きこう に めぐまれ がいてき の きょうい も ない。
      </p>
      <p>
        国王 の しんこうしん は あつく しゅうきょう の ほごしゃ として じいん と りょうこう な かんけい を きずいて いた。
      </p>
      <p><br/></p>
      <p>
        100年 の 平和 を きょうじゅ した 王国 だったが ふおんな な できごと が かくち で 見られる よう に なった。
        しぜんさいがい の ぞうか や てんこう の ふじゅん による ふさく が つづいた。
      </p>
      <p>
        おいうち を かける ように おきた 大日食 を きっかけ に ひとびと は ヤミ の 女王 アリル の ふっかつ を うわさする よう に なった。
      </p>

    </section>
    <section id="stage07:Forecourt" class="story bitfont">
      <p class="title">
        <span class="index"></span><br/><span class="name"></span>
      </p>
      <p></p>
      <p><br/></p>
    </section>
    <section id="stage08:Mausoleum" class="story bitfont">
      <p class="title">
        <span class="index"></span><br/><span class="name"></span>
      </p>
      <p></p>
      <p><br/></p>
    </section>
    <section id="stage04:Passkey" class="story bitfont">
      <p class="title">
        <span class="index"></span><br/><span class="name"></span>
      </p>
      <p></p>
      <p><br/></p>
    </section>
    <section id="stage02:Banners" class="story bitfont">
      <p class="title">
        <span class="index"></span><br/><span class="name"></span>
      </p>
      <p></p>
      <p><br/></p>
    </section>
    <section id="stage06:Loophole" class="story bitfont">
      <p class="title">
        <span class="index"></span><br/><span class="name"></span>
      </p>
      <p></p>
      <p><br/></p>
    </section>
    <section id="stage05:Dungeon" class="story bitfont">
      <p class="title">
        <span class="index"></span><br/><span class="name"></span>
      </p>
      <p></p>
      <p><br/></p>
    </section>
    <section id="stage03:Maze" class="story bitfont">
      <p class="title">
        <span class="index"></span><br/><span class="name"></span>
      </p>
      <p></p>
      <p><br/></p>
    </section>
    <section id="stage09:Core" class="story bitfont">
      <p class="title">
        <span class="index"></span><br/><span class="name"></span>
      </p>
      <p></p>
      <p><br/></p>
    </section>
    <section id="stage10:Lyra" class="story bitfont">
      <p class="title">
        <span class="index"></span><br/><span class="name"></span>
      </p>
      <p></p>
      <p><br/></p>
    </section>
    <section id="stage11:Epilogue" class="story bitfont">
      <p class="title">
        <span class="index"></span><br/><span class="name"></span>
      </p>
      <p></p>
      <p><br/></p>
    </section>
  </body>
</html>

